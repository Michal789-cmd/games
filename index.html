<!doctype html>
<html lang="cs">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>T≈ô√≠dƒõn√≠ odpadu ‚Äì v√Ωzva</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(255,255,255,.08);
      --panel2: rgba(255,255,255,.06);
      --border: rgba(255,255,255,.14);
      --text: rgba(255,255,255,.92);
      --muted: rgba(255,255,255,.72);
      --radius: 18px;
      --shadow: 0 20px 60px rgba(0,0,0,.45);
      --good: rgba(62,233,138,.22);
      --bad: rgba(255,107,107,.20);
      --focus: rgba(255,255,255,.25);
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans";
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(92,124,250,.35), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(255,158,61,.28), transparent 60%),
        radial-gradient(1000px 700px at 50% 90%, rgba(62,233,138,.18), transparent 55%),
        var(--bg);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .wrap{max-width:1100px;margin:0 auto;padding:clamp(14px,2.4vw,28px)}
    header{display:flex;justify-content:space-between;gap:12px;align-items:flex-start;margin-bottom:14px;flex-wrap:wrap}
    .brand{display:flex;gap:12px;align-items:center}
    .logo{
      width:42px;height:42px;border-radius:14px;
      background: linear-gradient(135deg, rgba(255,255,255,.18), rgba(255,255,255,.06));
      border:1px solid var(--border);
      box-shadow: 0 10px 30px rgba(0,0,0,.35);
      display:grid;place-items:center;font-weight:900;user-select:none
    }
    h1{margin:0;font-size:clamp(22px,2.6vw,30px);line-height:1.1}
    .sub{margin:6px 0 0 0;color:var(--muted);font-size:13px}
    .actions{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .btn{
      border:1px solid var(--border);
      background: rgba(255,255,255,.10);
      color:var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      cursor:pointer;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{transform:translateY(-1px);background:rgba(255,255,255,.14);border-color:rgba(255,255,255,.22)}
    .btn:focus-visible{outline:2px solid var(--focus);outline-offset:3px}
    .panel{
      background: linear-gradient(180deg, var(--panel), var(--panel2));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(8px);
      -webkit-backdrop-filter: blur(8px);
    }
    .layout{display:grid;grid-template-columns: 1fr 320px;gap:14px;align-items:start}
    @media (max-width:920px){.layout{grid-template-columns:1fr}}

    /* Stage */
    .game{padding:14px}
    .stage{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 14px;
      min-height: 520px;
      position: relative;
      overflow:hidden;
    }
    .hud{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-bottom: 12px;
    }
    @media (max-width:640px){.hud{grid-template-columns:1fr 1fr}}
    .card{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      border-radius: 16px;
      padding: 12px;
    }
    .label{color:var(--muted);font-size:12px;margin-bottom:6px}
    .value{font-size:18px;font-weight:1000}
    .value.small{font-size:12px;font-weight:900;color:rgba(255,255,255,.78)}

    .playfield{
      position: relative;
      height: 320px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.16);
      overflow:hidden;
    }

    /* Falling items */
    .fall{
      position:absolute;
      top: -60px;
      width: min(260px, 64%);
      left: 20px;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.10);
      padding: 12px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      cursor: grab;
      user-select:none;
      touch-action:none;
      box-shadow: 0 16px 40px rgba(0,0,0,.30);
      will-change: transform;
    }
    .fall:active{cursor: grabbing}
    .fall.dragging{transform: scale(1.02); z-index: 20}
    .fallLeft{display:flex;align-items:center;gap:10px}
    .emoji{font-size:26px}
    .name{font-weight:1000}
    .hint{color:var(--muted);font-size:12px}

    /* Bins */
    .bins{
      position:absolute;
      left: 14px;
      right: 14px;
      bottom: 14px;
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      z-index: 5;
    }
    @media (max-width:640px){
      .playfield{height: 360px;}
      .bins{grid-template-columns:1fr 1fr}
    }
    .bin{
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      padding: 12px;
      min-height: 92px;
      display:flex;
      flex-direction:column;
      justify-content:space-between;
      gap:10px;
      position: relative;
      overflow:hidden;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .binTop{display:flex;align-items:center;justify-content:space-between;gap:10px}
    .binName{font-weight:1000}
    .binIcon{font-size:22px}
    .binHelp{color:var(--muted);font-size:12px;line-height:1.25}
    .bin.dragover{outline:2px solid rgba(255,255,255,.35); outline-offset:-2px; background: rgba(255,255,255,.10)}
    .bin.goodflash{box-shadow: inset 0 0 0 9999px rgba(62,233,138,.14)}
    .bin.badflash{box-shadow: inset 0 0 0 9999px rgba(255,107,107,.12)}

    .bin[data-bin="plast"]{box-shadow: inset 0 0 0 9999px rgba(255, 209, 102, .10)}
    .bin[data-bin="kov"]{box-shadow: inset 0 0 0 9999px rgba(148, 163, 184, .10)}
    .bin[data-bin="karton"]{box-shadow: inset 0 0 0 9999px rgba(116, 192, 252, .10)}
    .bin[data-bin="sklo"]{box-shadow: inset 0 0 0 9999px rgba(128, 237, 153, .10)}

    .toast{
      position:absolute;
      top: 12px;
      left: 50%;
      transform: translateX(-50%);
      padding: 10px 12px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.35);
      font-weight:1000;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 30;
      white-space:nowrap;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(2px)}
    .toast.good{background: rgba(62,233,138,.22)}
    .toast.bad{background: rgba(255,107,107,.20)}

    .side{padding:14px;display:flex;flex-direction:column;gap:12px}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    select{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.08);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      font-weight: 900;
      outline:none;
    }
    .small{color:var(--muted);font-size:12px;line-height:1.35}
    .kbd{border:1px solid rgba(255,255,255,.16); padding: 3px 7px; border-radius: 8px; background: rgba(255,255,255,.06); font-weight: 1000; font-size: 12px}

    .overlay{
      position:absolute;
      inset:0;
      display:none;
      place-items:center;
      background: rgba(0,0,0,.55);
      backdrop-filter: blur(6px);
      -webkit-backdrop-filter: blur(6px);
      z-index: 40;
      padding: 16px;
    }
    .overlay.show{display:grid}
    .modal{
      width: min(520px, 96vw);
      border-radius: 20px;
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.06));
      box-shadow: 0 30px 90px rgba(0,0,0,.55);
      padding: 16px;
    }
    .modal h2{margin:0 0 8px 0}
    .modal p{margin:0 0 14px 0; color:var(--muted); font-size:13px; line-height:1.35}
    .modal .big{font-size:32px; font-weight:1000; margin: 6px 0 10px}
  </style>
</head>

<body>
  <div class="wrap">
    <header>
      <div class="brand">
        <div class="logo">‚ôªÔ∏è</div>
        <div>
          <h1>T≈ô√≠dƒõn√≠ odpadu ‚Äì v√Ωzva</h1>
          <p class="sub">Chytej padaj√≠c√≠ odpad a hoƒè ho do spr√°vn√©ho kontejneru. Postupnƒõ to zrychluje.</p>
        </div>
      </div>
      <div class="actions">
        <button id="btnStart" class="btn" type="button">‚ñ∂ Start</button>
        <button id="btnPause" class="btn" type="button">‚è∏ Pauza</button>
        <button id="btnReset" class="btn" type="button">üîÅ Nov√° hra</button>
      </div>
    </header>

    <div class="layout">
      <div class="panel game">
        <div class="stage" id="stage">
          <div class="toast" id="toast">OK</div>

          <div class="hud">
            <div class="card">
              <div class="label">Sk√≥re</div>
              <div class="value" id="score">0</div>
              <div class="value small" id="combo">Kombo: 0</div>
            </div>
            <div class="card">
              <div class="label">ƒåas</div>
              <div class="value" id="time">60</div>
              <div class="value small" id="speed">Rychlost: 1.0√ó</div>
            </div>
            <div class="card">
              <div class="label">≈Ωivoty</div>
              <div class="value" id="lives">‚ù§‚ù§‚ù§</div>
              <div class="value small" id="misses">Chyby: 0</div>
            </div>
            <div class="card">
              <div class="label">High score</div>
              <div class="value" id="hiscore">0</div>
              <div class="value small">lok√°lnƒõ</div>
            </div>
          </div>

          <div class="playfield" id="playfield">
            <div class="overlay" id="overlay">
              <div class="modal">
                <h2 id="overlayTitle">Pauza</h2>
                <p id="overlayText">Klikni na Pokraƒçovat.</p>
                <div class="big" id="overlayBig">‚è∏</div>
                <div class="row">
                  <button class="btn" id="btnResume" type="button">‚ñ∂ Pokraƒçovat</button>
                  <button class="btn" id="btnRestart2" type="button">üîÅ Nov√° hra</button>
                </div>
                <p class="small" style="margin-top:10px">
                  Tip: PC m≈Ø≈æe≈° chytat my≈°√≠. Mobil: dr≈æ kartiƒçku a t√°hni.<br>
                  Zkratky: <span class="kbd">P</span> pauza, <span class="kbd">R</span> restart.
                </p>
              </div>
            </div>

            <div class="bins" id="bins">
              <div class="bin" data-bin="plast">
                <div class="binTop"><div class="binName">Plast</div><div class="binIcon">üü®</div></div>
                <div class="binHelp">lahve, kel√≠mky, s√°ƒçky‚Ä¶</div>
              </div>
              <div class="bin" data-bin="kov">
                <div class="binTop"><div class="binName">Plech</div><div class="binIcon">ü•´</div></div>
                <div class="binHelp">plechovky, konzervy‚Ä¶</div>
              </div>
              <div class="bin" data-bin="karton">
                <div class="binTop"><div class="binName">Karton</div><div class="binIcon">üì¶</div></div>
                <div class="binHelp">krabice, pap√≠r‚Ä¶</div>
              </div>
              <div class="bin" data-bin="sklo">
                <div class="binTop"><div class="binName">Sklo</div><div class="binIcon">üü©</div></div>
                <div class="binHelp">l√°hve, sklenice‚Ä¶</div>
              </div>
            </div>
          </div>

          <div class="small" style="margin-top:10px">
            Pravidla: spr√°vnƒõ +1 (kombo zvy≈°uje body), ≈°patnƒõ ‚àí ≈æivot. Kdy≈æ odpad spadne dol≈Ø, taky ztrat√≠≈° ≈æivot.
          </div>
        </div>
      </div>

      <aside class="panel side">
        <div class="card">
          <div class="label">Nastaven√≠ v√Ωzvy</div>
          <div class="row">
            <label>
              <div class="small">D√©lka hry</div>
              <select id="duration">
                <option value="45">45 s</option>
                <option value="60" selected>60 s</option>
                <option value="90">90 s</option>
              </select>
            </label>
            <label>
              <div class="small">≈Ωivoty</div>
              <select id="livesSel">
                <option value="2">2</option>
                <option value="3" selected>3</option>
                <option value="4">4</option>
              </select>
            </label>
          </div>
          <div class="row" style="margin-top:8px">
            <label>
              <div class="small">Start rychlost</div>
              <select id="startSpeed">
                <option value="0.9">0.9√ó (lehƒç√≠)</option>
                <option value="1.0" selected>1.0√ó</option>
                <option value="1.15">1.15√ó (tƒõ≈æ≈°√≠)</option>
              </select>
            </label>
            <label>
              <div class="small">Zrychlov√°n√≠</div>
              <select id="ramp">
                <option value="slow">pomal√©</option>
                <option value="normal" selected>norm√°ln√≠</option>
                <option value="fast">rychl√©</option>
              </select>
            </label>
          </div>
          <div class="small" style="margin-top:8px">
            Kombo: ka≈æd√© spr√°vnƒõ zved√° kombo. Body = 1 + ‚åäkombo/5‚åã.
          </div>
        </div>

        <div class="card">
          <div class="label">Ovl√°d√°n√≠</div>
          <div class="small">
            Mobil: dr≈æ kartiƒçku ‚Üí t√°hni do ko≈°e.<br>
            PC: chy≈• my≈°√≠ ‚Üí p≈ôet√°hni.<br>
            <span class="kbd">P</span> pauza, <span class="kbd">R</span> restart.
          </div>
        </div>

        <div class="card">
          <div class="label">Roz≈°√≠≈ôen√≠ (pokud bude≈° cht√≠t je≈°tƒõ vƒõt≈°√≠ v√Ωzvu)</div>
          <div class="small">
            ‚Ä¢ ‚Äûfale≈°n√©‚Äú p≈ôedmƒõty (≈°pinav√© = net≈ô√≠dit) <br>
            ‚Ä¢ n√°pojov√© kartony jako 5. kategorie <br>
            ‚Ä¢ power-up: zpomal ƒças / extra ≈æivot <br>
            ‚Ä¢ re≈æim ‚Äûnekoneƒçno‚Äú ‚Äì do prvn√≠ho prohran√≠
          </div>
        </div>
      </aside>
    </div>
  </div>

<script>
(() => {
  // --- Items ---
  const ITEMS = [
    // plast
    { name:"PET lahev", emoji:"üß¥", bin:"plast" },
    { name:"Plastov√Ω kel√≠mek", emoji:"ü•§", bin:"plast" },
    { name:"S√°ƒçek", emoji:"üõçÔ∏è", bin:"plast" },
    { name:"F√≥lie", emoji:"üßª", bin:"plast" },
    // kov
    { name:"Plechovka", emoji:"ü•´", bin:"kov" },
    { name:"Konzerva", emoji:"ü•´", bin:"kov" },
    { name:"V√≠ƒçko (kov)", emoji:"ü´ô", bin:"kov" },
    { name:"Alobal", emoji:"üßª", bin:"kov" },
    // karton/pap√≠r
    { name:"Krabice", emoji:"üì¶", bin:"karton" },
    { name:"Pap√≠r", emoji:"üìÑ", bin:"karton" },
    { name:"Noviny", emoji:"üóûÔ∏è", bin:"karton" },
    { name:"Kart√≥nov√Ω obal", emoji:"üì¶", bin:"karton" },
    // sklo
    { name:"Sklenƒõn√° l√°hev", emoji:"üçæ", bin:"sklo" },
    { name:"Sklenice", emoji:"ü´ô", bin:"sklo" },
  ];

  const LS_HISCORE = "trash_sort_arcade_v2_hiscore";

  // --- DOM ---
  const playfield = document.getElementById("playfield");
  const bins = Array.from(document.querySelectorAll(".bin"));
  const toast = document.getElementById("toast");

  const elScore = document.getElementById("score");
  const elCombo = document.getElementById("combo");
  const elTime = document.getElementById("time");
  const elSpeed = document.getElementById("speed");
  const elLives = document.getElementById("lives");
  const elMisses = document.getElementById("misses");
  const elHi = document.getElementById("hiscore");

  const btnStart = document.getElementById("btnStart");
  const btnPause = document.getElementById("btnPause");
  const btnReset = document.getElementById("btnReset");

  const selDuration = document.getElementById("duration");
  const selLives = document.getElementById("livesSel");
  const selStartSpeed = document.getElementById("startSpeed");
  const selRamp = document.getElementById("ramp");

  const overlay = document.getElementById("overlay");
  const overlayTitle = document.getElementById("overlayTitle");
  const overlayText = document.getElementById("overlayText");
  const overlayBig = document.getElementById("overlayBig");
  const btnResume = document.getElementById("btnResume");
  const btnRestart2 = document.getElementById("btnRestart2");

  // --- Sound (simple WebAudio beeps) ---
  let audioCtx = null;
  function ensureAudio(){
    if (!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    if (audioCtx.state === "suspended") audioCtx.resume().catch(()=>{});
  }
  function beep(freq=440, dur=0.06, type="sine", gain=0.03){
    ensureAudio();
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type;
    o.frequency.value = freq;
    g.gain.value = gain;
    o.connect(g); g.connect(audioCtx.destination);
    o.start();
    o.stop(audioCtx.currentTime + dur);
  }
  const SFX = {
    good(){beep(740, 0.06, "triangle", 0.035)},
    bad(){beep(160, 0.11, "sawtooth", 0.05)},
    spawn(){beep(420, 0.03, "sine", 0.015)},
    start(){beep(520, 0.08, "sine", 0.04)},
    end(){beep(240, 0.16, "square", 0.05)},
    pause(){beep(300, 0.06, "sine", 0.03)}
  };

  // --- State ---
  let running=false, paused=false, gameOver=false;
  let score=0, combo=0, timeLeft=60, lives=3, misses=0;
  let hiscore = parseInt(localStorage.getItem(LS_HISCORE)||"0",10); if(!Number.isFinite(hiscore)) hiscore=0;
  elHi.textContent = String(hiscore);

  // difficulty
  let speedMult = 1.0;     // affects fall speed
  let spawnMs = 900;       // interval between spawns
  let baseFall = 90;       // px per second base (scaled by speedMult)
  let rampMode = "normal"; // slow/normal/fast

  // timers
  let timerId=null;
  let spawnId=null;
  let rafId=null;
  let lastT=0;

  // active falling objects
  let objs = []; // {id, item, x, y, vy, el, grabbed, ox, oy}
  let nextId=1;

  function randItem(){
    return ITEMS[Math.floor(Math.random()*ITEMS.length)];
  }

  function showToast(text, good){
    toast.textContent = text;
    toast.classList.remove("good","bad","show");
    toast.classList.add(good ? "good" : "bad");
    requestAnimationFrame(() => toast.classList.add("show"));
    setTimeout(() => toast.classList.remove("show"), 550);
  }

  function hearts(n){
    return "‚ù§".repeat(n) + "‚ô°".repeat(Math.max(0, 5-n));
  }

  function updateUI(){
    elScore.textContent = String(score);
    elCombo.textContent = `Kombo: ${combo}`;
    elTime.textContent = String(timeLeft);
    elLives.textContent = hearts(lives).slice(0, lives + Math.max(0, 5-lives)); // simple display
    elMisses.textContent = `Chyby: ${misses}`;
    elSpeed.textContent = `Rychlost: ${speedMult.toFixed(2)}√ó`;

    if (score > hiscore){
      hiscore = score;
      localStorage.setItem(LS_HISCORE, String(hiscore));
      elHi.textContent = String(hiscore);
    }
  }

  function flashBin(bin, good){
    bin.classList.remove("goodflash","badflash");
    bin.classList.add(good ? "goodflash" : "badflash");
    setTimeout(() => bin.classList.remove("goodflash","badflash"), 220);
  }

  function binUnderPointer(x,y){
    return bins.find(b => {
      const r = b.getBoundingClientRect();
      return x >= r.left && x <= r.right && y >= r.top && y <= r.bottom;
    }) || null;
  }

  function clearBinHighlights(){
    bins.forEach(b => b.classList.remove("dragover"));
  }
  function highlightBinUnderPointer(x,y){
    clearBinHighlights();
    const b = binUnderPointer(x,y);
    if (b) b.classList.add("dragover");
  }

  function pointsForCorrect(){
    // 1 + floor(combo/5)
    return 1 + Math.floor(combo / 5);
  }

  function onCorrect(obj, binEl){
    combo++;
    const pts = pointsForCorrect();
    score += pts;
    showToast(`‚úÖ +${pts}`, true);
    flashBin(binEl, true);
    SFX.good();
    removeObj(obj);
    updateUI();
  }

  function onWrong(obj, binEl){
    combo = 0;
    lives--;
    misses++;
    showToast("‚ùå ≈†patnƒõ!", false);
    flashBin(binEl, false);
    SFX.bad();
    removeObj(obj);
    if (lives <= 0) endGame(false);
    updateUI();
  }

  function onMiss(obj){
    combo = 0;
    lives--;
    misses++;
    showToast("üí• Spadlo dol≈Ø!", false);
    SFX.bad();
    removeObj(obj);
    if (lives <= 0) endGame(false);
    updateUI();
  }

  function removeObj(obj){
    objs = objs.filter(o => o !== obj);
    obj.el.remove();
  }

  function spawn(){
    if (!running || paused || gameOver) return;

    const it = randItem();
    const el = document.createElement("div");
    el.className = "fall";
    el.innerHTML = `
      <div class="fallLeft">
        <div class="emoji">${it.emoji}</div>
        <div>
          <div class="name">${it.name}</div>
          <div class="hint">T√°hni do spr√°vn√©ho ko≈°e</div>
        </div>
      </div>
      <div class="hint">‚Üò</div>
    `;
    playfield.appendChild(el);

    // initial x within playfield
    const pf = playfield.getBoundingClientRect();
    const maxX = Math.max(12, pf.width - el.getBoundingClientRect().width - 12);
    const x = 12 + Math.random() * maxX;

    const obj = {
      id: nextId++,
      item: it,
      x,
      y: -70,
      vy: baseFall * speedMult * (0.85 + Math.random()*0.35),
      el,
      grabbed:false,
      ox:0,
      oy:0,
      px:0,
      py:0
    };
    objs.push(obj);

    // pointer drag
    el.addEventListener("pointerdown", (e) => {
      if (!running || paused || gameOver) return;
      ensureAudio();
      obj.grabbed = true;
      el.classList.add("dragging");
      el.setPointerCapture(e.pointerId);

      // store pointer offset relative to element position
      const r = el.getBoundingClientRect();
      obj.ox = e.clientX - r.left;
      obj.oy = e.clientY - r.top;
      // freeze fall while grabbed (more controllable)
      obj.vy = 0;
    });

    el.addEventListener("pointermove", (e) => {
      if (!obj.grabbed) return;
      obj.px = e.clientX;
      obj.py = e.clientY;

      const pf = playfield.getBoundingClientRect();
      // convert pointer to playfield coords
      obj.x = (e.clientX - pf.left) - obj.ox;
      obj.y = (e.clientY - pf.top) - obj.oy;

      // clamp
      const w = el.getBoundingClientRect().width;
      obj.x = Math.max(8, Math.min(pf.width - w - 8, obj.x));
      obj.y = Math.max(-80, Math.min(pf.height - 80, obj.y));

      highlightBinUnderPointer(e.clientX, e.clientY);
      renderObj(obj);
    });

    el.addEventListener("pointerup", (e) => {
      if (!obj.grabbed) return;
      obj.grabbed = false;
      el.classList.remove("dragging");
      clearBinHighlights();

      const b = binUnderPointer(e.clientX, e.clientY);
      if (b){
        const ok = (b.dataset.bin === obj.item.bin);
        ok ? onCorrect(obj, b) : onWrong(obj, b);
        return;
      }

      // if not dropped into a bin, resume falling with current speed
      obj.vy = baseFall * speedMult * 1.05;
    });

    el.addEventListener("pointercancel", () => {
      obj.grabbed = false;
      el.classList.remove("dragging");
      clearBinHighlights();
      obj.vy = baseFall * speedMult * 1.05;
    });

    renderObj(obj);
    SFX.spawn();
  }

  function renderObj(obj){
    obj.el.style.transform = `translate(${obj.x}px, ${obj.y}px)`;
  }

  function loop(t){
    rafId = requestAnimationFrame(loop);
    if (!running || paused || gameOver) { lastT = t; return; }

    const dt = Math.min(0.033, (t - lastT) / 1000 || 0.016);
    lastT = t;

    const pf = playfield.getBoundingClientRect();
    const bottomLimit = pf.height - 86; // above bins a bit

    for (const o of objs.slice()){
      if (!o.grabbed){
        o.y += o.vy * dt;
        renderObj(o);
        if (o.y > bottomLimit){
          onMiss(o);
        }
      }
    }
  }

  function applyDifficulty(){
    timeLeft = parseInt(selDuration.value, 10);
    lives = parseInt(selLives.value, 10);
    speedMult = parseFloat(selStartSpeed.value);
    rampMode = selRamp.value;

    // spawn interval baseline (lower = harder)
    // speed also affects vy via speedMult
    spawnMs = Math.round(900 / speedMult);
    baseFall = 95;

    updateUI();
  }

  function startGame(){
    ensureAudio();
    resetGame(false);
    applyDifficulty();

    running = true;
    paused = false;
    gameOver = false;
    score = 0; combo = 0; misses = 0;

    // clear existing
    objs.forEach(o => o.el.remove());
    objs = [];

    overlay.classList.remove("show");
    SFX.start();
    updateUI();

    // timer
    clearInterval(timerId);
    timerId = setInterval(() => {
      if (!running || paused || gameOver) return;
      timeLeft--;
      if (timeLeft <= 0){
        timeLeft = 0;
        endGame(true);
      }

      // ramp speed over time
      if (rampMode === "slow"){
        speedMult *= 1.005;
      } else if (rampMode === "fast"){
        speedMult *= 1.012;
      } else {
        speedMult *= 1.008;
      }

      // update spawn interval and apply to non-grabbed objects
      spawnMs = Math.max(340, Math.round(900 / speedMult));
      updateUI();
    }, 1000);

    // spawner
    clearInterval(spawnId);
    spawnId = setInterval(() => {
      if (!running || paused || gameOver) return;
      // keep max active items to avoid chaos
      if (objs.length < 6) spawn();
    }, spawnMs);

    // animation
    lastT = performance.now();
    cancelAnimationFrame(rafId);
    rafId = requestAnimationFrame(loop);
  }

  function endGame(winOnTime){
    running = false;
    paused = false;
    gameOver = true;

    clearInterval(timerId); timerId = null;
    clearInterval(spawnId); spawnId = null;

    overlay.classList.add("show");
    overlayTitle.textContent = winOnTime ? "ƒåas!" : "Konec hry";
    overlayText.textContent = winOnTime
      ? "Dohr√°l jsi do konce. Zkus vy≈°≈°√≠ start rychlost nebo rychl√© zrychlov√°n√≠."
      : "Do≈°ly ≈æivoty. Zkus pomalej≈°√≠ start nebo v√≠c ≈æivot≈Ø.";
    overlayBig.textContent = winOnTime ? "‚è±Ô∏è" : "üí•";
    SFX.end();
    updateUI();
  }

  function togglePause(){
    if (!running || gameOver) return;
    paused = !paused;
    overlay.classList.toggle("show", paused);
    overlayTitle.textContent = "Pauza";
    overlayText.textContent = "Klikni na Pokraƒçovat.";
    overlayBig.textContent = "‚è∏";
    SFX.pause();
  }

  function resetGame(showOverlay=true){
    running = false;
    paused = false;
    gameOver = false;

    clearInterval(timerId); timerId=null;
    clearInterval(spawnId); spawnId=null;
    cancelAnimationFrame(rafId);

    // clear objects
    objs.forEach(o => o.el.remove());
    objs = [];

    score = 0; combo = 0; misses = 0;
    applyDifficulty();
    updateUI();

    if (showOverlay){
      overlay.classList.add("show");
      overlayTitle.textContent = "P≈ôipraven?";
      overlayText.textContent = "Klikni na Start. Pak u≈æ to pojede.";
      overlayBig.textContent = "‚ôªÔ∏è";
    } else {
      overlay.classList.remove("show");
    }
  }

  // Toast
  function showToast(text, good){
    toast.textContent = text;
    toast.classList.remove("good","bad","show");
    toast.classList.add(good ? "good" : "bad");
    requestAnimationFrame(() => toast.classList.add("show"));
    setTimeout(() => toast.classList.remove("show"), 520);
  }

  // Bin hover for desktop dragover (optional visual; we use pointer)
  bins.forEach(b => {
    b.addEventListener("mouseenter", () => { if (running && !paused) b.classList.add("dragover"); });
    b.addEventListener("mouseleave", () => b.classList.remove("dragover"));
  });

  // Buttons
  btnStart.addEventListener("click", startGame);
  btnPause.addEventListener("click", () => { ensureAudio(); togglePause(); });
  btnReset.addEventListener("click", () => { ensureAudio(); resetGame(true); });

  btnResume.addEventListener("click", () => {
    if (gameOver) return;
    overlay.classList.remove("show");
    paused = false;
    SFX.pause();
  });
  btnRestart2.addEventListener("click", () => { ensureAudio(); startGame(); });

  // Keyboard
  window.addEventListener("keydown", (e) => {
    ensureAudio();
    if (e.key.toLowerCase() === "p"){ e.preventDefault(); togglePause(); }
    if (e.key.toLowerCase() === "r"){ e.preventDefault(); startGame(); }
  });

  // Init
  resetGame(true);
})();
</script>
</body>
</html>
